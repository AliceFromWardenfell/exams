#include "microshell.h"

int	initialization(t_main *m, int argc, char ** argv, char **env)
{
	m->info.argc = argc;
	m->info.argv = argv;
	m->info.env = env;
	m->info.num_of_cmds = 1;
	m->cmd = NULL;
	m->backup_fd_in = dup(0);
	m->backup_fd_out = dup(1);
	m->pipe[0] = -1;
	m->pipe[1] = -1;
	return (OK);
}

int	wait_loop(t_cmd *cmd)
{
	while (cmd)
	{
		// printf("%d\n", cmd->pid);
		if (cmd->pid != -1 && cmd->pid != 0)
			if (waitpid(cmd->pid, NULL, 0) == -1)
			{
				return (print_error("waitpid"));
			}
		cmd = cmd->next;
	}
	return (OK);
}

int	main(int argc, char **argv, char **env)
{
	t_main m;

	initialization(&m, argc, argv, env);
	if (parser(&m))
		return (ERROR);
	if (executor(&m))
		return (ERROR);
	if (wait_loop(m.cmd))
		return (ERROR);
	fd_restore(&m);
	close(m.backup_fd_in);
	close(m.backup_fd_out);
	return (OK);
}
